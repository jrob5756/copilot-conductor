# KPI Analysis Workflow
#
# This workflow analyzes SFI KPIs from a JSON directory, processing each KPI
# through a dedicated analyzer agent.
#
# Architecture:
# - Finder: Reads JSON, checks output dir for already-processed KPIs, returns next KPI to process
# - Analyzer: For the given KPI, queries S360/Eng Hub tools and appends to category doc
#
# Prerequisites:
# - S360 MCP tools must be available in the environment
# - Eng Hub MCP tools must be available in the environment
#
# Usage:
#   conductor run examples/kpi-analysis.yaml --input kpi_directory="/path/to/kpi-directory.json"
#
# With specific category filter:
#   conductor run examples/kpi-analysis.yaml --input kpi_directory="..." --input category="Engineering Systems"

workflow:
  name: kpi-analysis
  description: Analyze SFI KPIs and generate resolution documentation
  version: "3.0.0"
  entry_point: finder

  runtime:
    provider: copilot
    mcp_servers:
      enghub:
        command: node
        args: ["/Users/jason/src/enghub-mcp-server-tools/dist/index.js"]
        tools: ["*"]
      s360:
        type: http
        url: https://mcp.vnext.s360.msftcloudes.com/
        tools: ["*"]


  input:
    kpi_directory:
      type: string
      required: true
      description: Path to the KPI directory JSON file
    category:
      type: string
      required: false
      description: A specific category to analyze. If not provided, all categories are processed
    output_dir:
      type: string
      required: false
      default: "/Users/jason/src/notes/projects/ai-development/anti-patterns/get-green-stay-green/analysis"
      description: Directory where analysis documents will be saved

  context:
    mode: accumulate

  limits:
    max_iterations: 500

agents:
  - name: finder
    description: Finds the next unprocessed KPI by checking existing output files
    model: sonnet
    input:
      - workflow.input.kpi_directory
      - workflow.input.output_dir
      - workflow.input.category?
    system_prompt: |
      You are a KPI Finder agent. Your task is to:
      1. Read the KPI directory JSON file
      2. Check the output directory for existing category markdown files
      3. Parse those files to find which KPI IDs have already been analyzed
      4. Return the next unprocessed KPI
    prompt: |
      Find the next unprocessed KPI.

      **KPI Directory JSON:** {{ workflow.input.kpi_directory }}
      **Output Directory:** {{ workflow.input.output_dir }}
      {% if workflow.input.category %}
      **Filter to Category:** {{ workflow.input.category }}
      {% endif %}

      ## TASKS

      1. **Read the KPI Directory JSON**
         Load the JSON file at the given path to get all KPIs.
         Each KPI object has: kpi_id, title, domain, owner, category_name, category_filename

      2. **Filter by Category (if specified)**
         If a category filter is provided, only consider KPIs matching that category_name.

      3. **Check Existing Output Files**
         For each unique category_filename in the KPI list:
         - Check if the file exists at {{ workflow.input.output_dir }}/[category_filename]
         - If it exists, read the file and extract all KPI IDs that appear as "## [KPI_ID] - "
         - Track which KPI IDs have already been processed

      4. **Find First Unprocessed KPI**
         - Go through the KPI list in order
         - Find the first KPI whose kpi_id is NOT in the processed set
         - Return that KPI's full data

      5. **Calculate Progress**
         - Count total KPIs (after category filter if applied)
         - Count how many have been processed
         - Determine the index of the next KPI to process
    output:
      next_kpi:
        type: object
        description: "The next KPI to analyze with keys: kpi_id, title, domain, owner, category_name, category_filename"
      next_kpi_index:
        type: number
        description: The index of the next KPI in the list
      total_kpis:
        type: number
        description: Total number of KPIs to process
      processed_count:
        type: number
        description: Number of KPIs already processed
      all_complete:
        type: boolean
        description: Whether all KPIs have been processed
    routes:
      - to: $end
        when: "{{ output.all_complete }}"
      - to: analyzer

  - name: analyzer
    description: Analyzes a single KPI using S360 and Eng Hub tools, then saves to category doc
    model: opus-4.5
    input:
      - finder.output
      - workflow.input.output_dir
    system_prompt: |
      You are a KPI Analysis agent specializing in Microsoft SFI (Secure Future Initiative) compliance.
      
      Your task is to:
      1. Analyze the given KPI using S360 and Eng Hub tools
      2. Append the analysis to the appropriate category markdown file

      You have access to:
      - S360 tools: Query KPI details, compliance status, work items
      - Eng Hub tools: Search documentation, find remediation guides
      - File tools: Read and write to the output directory
    prompt: |
      Analyze this KPI and save it to the category document.

      **Output Directory:** {{ workflow.input.output_dir }}
      
      **KPI to Analyze:**
      - ID: {{ finder.output.next_kpi.kpi_id }}
      - Title: {{ finder.output.next_kpi.title }}
      - Domain: {{ finder.output.next_kpi.domain }}
      - Owner: {{ finder.output.next_kpi.owner }}
      - Category: {{ finder.output.next_kpi.category_name }}
      - Output File: {{ finder.output.next_kpi.category_filename }}

      **Progress:** {{ finder.output.processed_count }} / {{ finder.output.total_kpis }} completed

      ## TASKS

      1. **Query S360 for KPI Details**
         Use the KPI ID ({{ finder.output.next_kpi.kpi_id }}) to:
         - Get the full KPI definition and requirements
         - Check current compliance status
         - Retrieve any existing work items

      2. **Gather KPI Metrics from S360**
         Query S360 to collect the following metrics:
         - **Volume:** Number of open S360 action items for this KPI
         - **Age:** Average age of open S360 items (days since created)
         - **Impact:** Customer impact, security impact, or business criticality
         - **Frequency:** How often new items are created for this KPI
         - **Resolution Time:** Average time to resolve items for this KPI

      3. **Find Documentation in Eng Hub**
         Search for documentation related to this KPI:
         - Find remediation guides and best practices
         - Look for related tooling or automation

      4. **Append to Category Document**
         File: {{ workflow.input.output_dir }}/{{ finder.output.next_kpi.category_filename }}
         
         If the file doesn't exist, create it with a header:
         ```markdown
         # {{ finder.output.next_kpi.category_name }} KPI Analysis
         
         Generated: [Date]
         
         ---
         ```
         
         Then append this KPI's analysis:
         ```markdown
         ## {{ finder.output.next_kpi.kpi_id }} - {{ finder.output.next_kpi.title }}
         
         **Domain:** {{ finder.output.next_kpi.domain }}
         **Owner:** {{ finder.output.next_kpi.owner }}
         **Priority:** [Critical/High/Medium/Low]
         
         ### Summary
         [What this KPI measures and why it matters]
         
         ### Compliance Status
         [Current status from S360]
         
         ### Metrics
         | Metric | Value |
         |--------|-------|
         | Open Items | [count] |
         | Average Age | [X days] |
         | Impact | [High/Medium/Low] |
         | Frequency | [X new items/week] |
         | Avg Resolution Time | [X days] |
         
         ### Resolution Steps
         1. [Step 1]
         2. [Step 2]
         ...
         
         ### Documentation
         - [Link 1]
         - [Link 2]
         
         ---
         ```
    output:
      kpi_id:
        type: string
        description: The KPI ID that was just analyzed
      success:
        type: boolean
        description: Whether the analysis was saved successfully
    routes:
      - to: finder

output:
  total_kpis: "{{ finder.output.total_kpis }}"
  completed: "{{ finder.output.processed_count }}"
  iterations: "{{ context.iteration }}"
