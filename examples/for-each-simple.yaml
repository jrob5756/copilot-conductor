# For-Each Simple
#
# This example demonstrates dynamic parallel execution with for-each groups.
# It shows:
# - Processing variable-length arrays with for-each
# - Loop variables ({{ item }}, {{ _index }}, {{ _key }})
# - Index-based output aggregation
# - Batched parallel execution
# - Accessing for-each outputs in downstream agents
#
# Usage:
#   conductor run examples/for-each-simple.yaml

workflow:
  name: for-each-simple
  description: Simple demonstration of for-each dynamic parallel execution
  version: "1.0.0"
  entry_point: item_finder
  
  runtime:
    provider: copilot
    default_model: claude-sonnet-4.5
  
  limits:
    max_iterations: 20

# For-each group definition
for_each:
  - name: item_processors
    type: for_each
    description: Process each item found by the item_finder
    
    source: item_finder.output.items  # Reference to array in context
    as: item                           # Loop variable name
    max_concurrent: 3                  # Process 3 items at a time
    failure_mode: continue_on_error    # Continue even if some items fail
    
    agent:
      name: item_processor
      model: claude-sonnet-4.5
      prompt: |
        You are a data processor. Process this item:
        
        Item {{ _index + 1 }}: {{ item }}
        
        Provide a brief analysis and transformation.
      output:
        original:
          type: string
          description: Original item value
        processed:
          type: string
          description: Processed/transformed value
        analysis:
          type: string
          description: Brief analysis
    
    routes:
      - to: aggregator

agents:
  # Agent 1: Find items to process
  - name: item_finder
    description: Finds a list of items to process
    model: claude-sonnet-4.5
    prompt: |
      Generate a list of 5 interesting programming concepts to analyze.
      
      Return them as a simple array of strings.
      Examples: "functional programming", "type systems", "concurrency"
    output:
      items:
        type: array
        description: List of items (strings) to process
    routes:
      - to: item_processors
  
  # Agent 2: Aggregate results
  - name: aggregator
    description: Aggregates results from all processed items
    model: claude-sonnet-4.5
    input:
      - item_finder.output
      - item_processors.outputs
    prompt: |
      Summarize the batch processing results:
      
      Original Items ({{ item_finder.output.items | length }}):
      {% for item in item_finder.output.items %}
      {{ loop.index }}. {{ item }}
      {% endfor %}
      
      Successfully Processed ({{ item_processors.outputs | length }}):
      {% for result in item_processors.outputs %}
      {{ loop.index }}. Original: {{ result.original }}
         Processed: {{ result.processed }}
         Analysis: {{ result.analysis }}
      {% endfor %}
      
      {% if item_processors.errors is defined and item_processors.errors %}
      Failed Items ({{ item_processors.errors | length }}):
      {% for idx, error in item_processors.errors.items() %}
      - Index {{ idx }}: {{ error.message }}
      {% endfor %}
      {% endif %}
      
      Provide:
      1. Overall summary of processing
      2. Key insights from analyses
      3. Processing success rate
    output:
      summary:
        type: string
        description: Executive summary
      insights:
        type: array
        description: Key insights from all analyses
      success_rate:
        type: string
        description: Success rate (e.g., "5/5" or "4/5")
    routes:
      - to: $end

output:
  summary: "{{ aggregator.output.summary }}"
  insights: "{{ aggregator.output.insights | json }}"
  success_rate: "{{ aggregator.output.success_rate }}"
  total_items: "{{ item_finder.output.items | length }}"
  processed: "{{ item_processors.outputs | length }}"
  failed: "{% if item_processors.errors is defined %}{{ item_processors.errors | length }}{% else %}0{% endif %}"

