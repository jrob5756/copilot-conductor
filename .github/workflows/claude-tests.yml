# Claude Provider Tests workflow
#
# Runs on:
# - Scheduled (weekly on Mondays at 9 AM UTC)
# - Manual trigger (workflow_dispatch)
#
# This workflow runs tests that make real API calls to the Anthropic Claude API.
# These tests are separated from the main CI to avoid consuming API quota on every PR.
#
# SETUP INSTRUCTIONS:
# To enable real API tests, set the following in your GitHub repository:
#   1. Secrets → Add ANTHROPIC_API_KEY with your Anthropic API key
#   2. Variables → Add ANTHROPIC_API_KEY_AVAILABLE with value "true"
#
# Without these configured, only mock tests will run (no real API calls).

name: Claude Provider Tests

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      test_pattern:
        description: 'Test pattern to run (e.g., "test_claude" or leave empty for all)'
        required: false
        default: ''

env:
  PYTHON_VERSION: "3.12"

jobs:
  claude-tests:
    name: Claude Real API Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --group dev

      - name: Run Claude provider tests (mock only)
        if: github.event_name == 'schedule' || github.event.inputs.test_pattern == ''
        run: uv run pytest tests/test_providers/test_claude.py tests/test_integration/test_claude_workflows.py -v -m "not real_api"
        env:
          # Mock tests don't make real API calls - this prevents accidental API usage
          ANTHROPIC_API_KEY: "mock-key-not-used"

      - name: Run Claude real API tests (requires ANTHROPIC_API_KEY secret)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_pattern == '' && vars.ANTHROPIC_API_KEY_AVAILABLE == 'true'
        run: uv run pytest tests/test_integration/test_claude_real_api.py -v -m "real_api"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Run custom test pattern
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_pattern != ''
        run: uv run pytest -k "${{ github.event.inputs.test_pattern }}" -v -m "not real_api"
        env:
          # Mock tests don't make real API calls - this prevents accidental API usage
          ANTHROPIC_API_KEY: "mock-key-not-used"
