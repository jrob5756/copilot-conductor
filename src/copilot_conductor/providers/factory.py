"""Factory for creating agent providers.

This module provides the create_provider factory function for instantiating
the appropriate AgentProvider based on the requested provider type.
"""

from __future__ import annotations

from typing import Any, Literal

from copilot_conductor.exceptions import ProviderError
from copilot_conductor.providers.base import AgentProvider
from copilot_conductor.providers.claude import ANTHROPIC_SDK_AVAILABLE, ClaudeProvider
from copilot_conductor.providers.copilot import CopilotProvider


async def create_provider(
    provider_type: Literal["copilot", "openai-agents", "claude"] = "copilot",
    validate: bool = True,
    mcp_servers: dict[str, Any] | None = None,
    default_model: str | None = None,
    temperature: float | None = None,
    max_tokens: int | None = None,
    timeout: float | None = None,
) -> AgentProvider:
    """Factory function to create the appropriate provider.

    Creates and optionally validates an AgentProvider instance based on
    the requested provider type. Validation ensures the provider can
    connect to its backend before returning.

    Args:
        provider_type: Which SDK provider to use. Currently supports
            "copilot" and "claude".
        validate: Whether to validate connection on creation. If True,
            calls validate_connection() and raises ProviderError on failure.
        mcp_servers: MCP server configurations to pass to the provider.
            Note: Phase 1 Claude provider does not support MCP servers.
        default_model: Default model to use for agents that don't specify one.
        temperature: Default temperature for generation (0.0-1.0).
        max_tokens: Maximum output tokens.
        timeout: Request timeout in seconds.

    Returns:
        Configured AgentProvider instance.

    Raises:
        ProviderError: If provider type is unknown or connection validation fails.

    Example:
        >>> provider = await create_provider("copilot")
        >>> # Use provider for agent execution
        >>> await provider.close()
    """
    match provider_type:
        case "copilot":
            provider = CopilotProvider(
                mcp_servers=mcp_servers,
                model=default_model,
                temperature=temperature,
            )
        case "openai-agents":
            raise ProviderError(
                "OpenAI Agents provider not yet implemented",
                suggestion="Use 'copilot' provider for now",
            )
        case "claude":
            if not ANTHROPIC_SDK_AVAILABLE:
                raise ProviderError(
                    "Claude provider requires anthropic SDK",
                    suggestion="Install with: uv add 'anthropic>=0.77.0,<1.0.0'",
                )
            # Phase 1: MCP servers not supported for Claude provider
            # Will be added in Phase 2 (EPIC-005)
            provider = ClaudeProvider(
                model=default_model,
                temperature=temperature,
                max_tokens=max_tokens,
                timeout=timeout if timeout is not None else 600.0,
            )
        case _:
            raise ProviderError(
                f"Unknown provider: {provider_type}",
                suggestion="Valid providers are: copilot, openai-agents, claude",
            )

    if validate and not await provider.validate_connection():
        raise ProviderError(
            f"Failed to connect to {provider_type} provider",
            suggestion="Check your credentials and network connection",
        )

    return provider
